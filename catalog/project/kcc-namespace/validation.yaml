apiVersion: fn.kpt.dev/v1alpha1
kind: StarlarkRun
metadata:
  name: validate-project-ns
source: |
  def get_tenant_ns(resource_list):
    for resource in resource_list["items"]:
      if resource["kind"] == "Namespace":
        return resource["metadata"]["name"]
    fail("unable to find tenant project namespace")

  def get_projects_ns(resource_list):
    for resource in resource_list["items"]:
      # owner IAMPartialPolicy is expected to be in projects ns
      if resource["kind"] == "IAMPartialPolicy" and resource["metadata"]["name"].endswith("owners-permissions"):
        return resource["metadata"]["namespace"]
    fail("unable to find project owner IAMPartialPolicy")
    
  tenant_ns = get_tenant_ns(ctx.resource_list)
  projects_ns = get_projects_ns(ctx.resource_list)
  if tenant_ns == projects_ns:
    fail("projects-namespace cannot be the same as tenant project")
apiVersion: iam.cnrm.cloud.google.com/v1beta1 # Service Account for GKE nodes
kind: IAMServiceAccount
metadata:
  annotations:
    cnrm.cloud.google.com/blueprint: cnrm/gke:gke-cluster-nodepool/v0.2.0-alpha.1
    cnrm.cloud.google.com/project-id: platform-project-id # {"$kpt-set":"platform-project-id"}
  name: gke-example-us-east4-primary # {"$kpt-set":"krm-service-account-name"}
  namespace: config-control # {"$kpt-set":"platform-namespace"}
spec:
  displayName: gke-example-us-east4-primary # {"$kpt-set":"krm-service-account-name"}
---
apiVersion: iam.cnrm.cloud.google.com/v1beta1 # Allow fluentd to send logs to StackDriver
kind: IAMPolicyMember
metadata:
  annotations:
    cnrm.cloud.google.com/blueprint: cnrm/gke:gke-cluster-nodepool/v0.2.0-alpha.1
  name: logwriter-gke-example-us-east4-primary # {"$kpt-set":"krm-logwriter-policy-name"}
  namespace: config-control # {"$kpt-set":"platform-namespace"}
spec:
  memberFrom:
    serviceAccountRef:
      name: gke-example-us-east4-primary # {"$kpt-set":"krm-service-account-name"}
      namespace: config-control # {"$kpt-set":"platform-namespace"}
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    external: platform-project-id # {"$kpt-set":"platform-project-id"}
    kind: Project
  role: roles/logging.logWriter
---
apiVersion: iam.cnrm.cloud.google.com/v1beta1 # Allow fluentd to send metrics to StackDriver
kind: IAMPolicyMember
metadata:
  annotations:
    cnrm.cloud.google.com/blueprint: cnrm/gke:gke-cluster-nodepool/v0.2.0-alpha.1
  name: metricwriter-gke-example-us-east4-primary # {"$kpt-set":"krm-metricwriter-policy-name"}
  namespace: config-control # {"$kpt-set":"platform-namespace"}
spec:
  memberFrom:
    serviceAccountRef:
      name: gke-example-us-east4-primary # {"$kpt-set":"krm-service-account-name"}
      namespace: config-control # {"$kpt-set":"platform-namespace"}
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    external: platform-project-id # {"$kpt-set":"platform-project-id"}
    kind: Project
  role: roles/monitoring.metricWriter
---
apiVersion: iam.cnrm.cloud.google.com/v1beta1 # Allow kubelet/docker/containerd to read all artifacts/images in the platform-project-id project
kind: IAMPolicyMember
metadata:
  annotations:
    cnrm.cloud.google.com/blueprint: cnrm/gke:gke-cluster-nodepool/v0.2.0-alpha.1
  name: artifactreader-gke-example-us-east4-primary # {"$kpt-set":"krm-artifactreader-policy-name"}
  namespace: config-control # {"$kpt-set":"platform-namespace"}
spec:
  memberFrom:
    serviceAccountRef:
      name: gke-example-us-east4-primary # {"$kpt-set":"krm-service-account-name"}
      namespace: config-control # {"$kpt-set":"platform-namespace"}
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    external: platform-project-id # {"$kpt-set":"platform-project-id"}
    kind: Project
  role: roles/artifactregistry.reader

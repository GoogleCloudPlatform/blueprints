# Grant GKE GSA in the platform project permission to use the Shared VPC
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: platform-project-id-container-network-user # {"$kpt-set":"krm-container-network-user-name"}
  namespace: network-project-id # {"$kpt-set":"network-project-id"}
  annotations:
    cnrm.cloud.google.com/project-number-ref: '{"namespace": "projects", "name": "platform-project-id"}' # {"$kpt-set":"platform-project-ref"}
    config.kubernetes.io/function: |
      container:
        image: gcr.io/yakima-eap/project-number-ref:latest
spec:
  member: "serviceAccount:service-${project-number}@container-engine-robot.iam.gserviceaccount.com"
  role: roles/compute.networkUser
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    name: network-project-id # {"$kpt-set":"network-project-id"}
    namespace: projects # {"$kpt-set":"projects-namespace"}
---
# Grant "Google APIs Service Agent" in the platform project permission to use the Shared VPC
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: platform-project-id-cloudservices-network-user # {"$kpt-set":"krm-cloudservices-network-user-name"}
  namespace: network-project-id # {"$kpt-set":"network-project-id"}
  annotations:
    cnrm.cloud.google.com/project-number-ref: '{"namespace": "projects", "name": "platform-project-id"}' # {"$kpt-set":"platform-project-ref"}
    config.kubernetes.io/function: |
      container:
        image: gcr.io/yakima-eap/project-number-ref:latest
spec:
  member: "serviceAccount:${project-number}@cloudservices.gserviceaccount.com"
  role: roles/compute.networkUser
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    name: network-project-id # {"$kpt-set":"network-project-id"}
    namespace: projects # {"$kpt-set":"projects-namespace"}
---
# Grant GKE GSA in the platform project permission to act as the "Google APIs Service Agent"
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: service-project-id-container-cloudservices-user # {"$kpt-set":"krm-container-cloudservices-user-name"}
  namespace: network-project-id # {"$kpt-set":"network-project-id"}
  annotations:
    cnrm.cloud.google.com/project-number-ref: '{"namespace": "projects", "name": "platform-project-id"}' # {"$kpt-set":"platform-project-ref"}
    config.kubernetes.io/function: |
      container:
        image: gcr.io/yakima-eap/project-number-ref:latest
spec:
  member: "serviceAccount:service-${project-number}@container-engine-robot.iam.gserviceaccount.com"
  role: roles/container.hostServiceAgentUser
  resourceRef:
    apiVersion: resourcemanager.cnrm.cloud.google.com/v1beta1
    kind: Project
    name: network-project-id # {"$kpt-set":"network-project-id"}
    namespace: projects # {"$kpt-set":"projects-namespace"}

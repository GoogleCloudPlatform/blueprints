# GitLab Git Ops Pipeline
## Author:
jcwc@

[TOC]

## Prerequisites:
- [Terraform](https://www.terraform.io/downloads.html)
- [gcloud](https://cloud.google.com/sdk/gcloud)
- [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
  - Installed and contains context for Yakima cluster
- [Git](https://git-scm.com/downloads)
  - Installed and configured with user.email
- Yakima cluster

## Description:
This blueprint instantiates a GitLab in-cluster instance within a pre-existing Yakima managed cluster and creates the necessary components for a fully functional Git Ops CI/CD pipeline. After installing the blueprint, you will be able to:
1. Manage your infrastructure via version control.
2. Create merge requests to review changes
3. Manage plain KRM or blueprints and specify kpt functions for GitLab CI to use
   to hydrate/ validate your configs
4. Automatically apply your git repo configs to your Yakima cluster on merge
<!-- ... insert more as needed. -->

The components generated by this blueprint include:
  - [Config Sync](https://cloud.google.com/kubernetes-engine/docs/add-on/config-sync/overview) w/ SSH credentials configured
    - This allows Yakima to apply KRM directly from the deployment repo to the Yakima cluster.
  - Source repo (DRY)
    - This is where your changes will be made. You can push plain KRM or [blueprints](https://googlecontainertools.github.io/kpt/guides/producer/blueprint/).
  - [Gitlab CI configuration](https://docs.gitlab.com/ee/ci/yaml/)
    - After source repo changes are pushed/ merged, if your contents are a [blueprint](https://googlecontainertools.github.io/kpt/guides/producer/blueprint/), then GitLab CI will perform hydration and validation using your specified kpt functions. This is a no-op if you are using plain KRM. Changes are then pushed to the deployment repo under the `config` folder to be applied to the Yakima cluster by Config Sync.
  - Deployment repo (WET) w/ deploy key configured
    - After source repo changes are made, this is where hydrated configurations are pushed to and applied to your cluster via Config Sync.


### To apply the blueprint:
1. Navigate to `gitlab-in-cluster` folder: `cd gitlab-in-cluster`
   1. Create a `terraform.tfvars` file and configure the file.
      1. You can refer to `example.tfvars` for example usage and
         `variables.tfvars` as documentation reference.
   2. Run `terraform init && terraform plan` to preview your changes.
   3. Run `terraform apply` to apply your changes.
   4. Your GitLab instance has been created. Login with the credentials provided
      in the GitLab output to modify your repo however you see fit.
      1. Keep track of your `personal_access_token`. You will need it later.
2. Navigate to `git-ops-pipeline` folder: `cd ../git-ops-pipeline`
   1. Create a `terraform.tfvars` file and configure the file.
      1. You can refer to `example.tfvars` for example usage and
         `variables.tfvars` as documentation reference.
      2. Personal access token can be obtained from the output of the previous
         `terraform apply` command output or by running
         `terraform output personal_access_token` in the `gitlab-in-cluster`
         folder
   2. Run `terraform init && terraform plan` to preview your changes.
   3. Run `terraform apply` to apply your changes.
   4. Use the outputs from the apply command to apply changes to your source
      repo. It will be passed through the git ops pipeline and applied using
      Yakima.

*Note: the above steps can be ran without using `terraform.tfvars` but will need
command line inputs.*

## FAQS:
- Is there a single command to run this blueprint?
  - This is a WIP

- I applied the blueprint and got into a partial state and it failed. What
  should I do?
  - Attempt to re-apply the failed blueprint first and see if it works.
  - If you have conflicting resources that already exist, see if the tfvars
    can be modified to avoid the conflict. If not, try manually deleting the
    pre-existing resources or
    [importing them to Terraform](https://www.terraform.io/docs/import/index.html).
  - Since certain parts of the blueprint are done imperatively via
    [Terraform provisioners](https://www.terraform.io/docs/provisioners/index.html),
    sometimes, the only option is to delete the rogue resources and retry
    creation. Some things that may need manual attention are:
    - Deleting `git-creds` secret in the `config-management-system` namespace
      - `kubectl delete secret git-creds -n config-management-system`
    <!-- ... insert more as we find them -->

- Should this blueprint be used for production?
  - At the moment, it is **not** recommended to use this blueprint for production. The contents of this blueprint is meant to be a proof of concept and will not scale with production workloads. In the future, we will be making iterations to make the blueprint more production friendly.

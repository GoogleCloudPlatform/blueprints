apiVersion: kpt.dev/v1alpha1
kind: Kptfile
metadata:
  name: csr-git-ops-pipeline
packageMetadata:
  shortDescription: This blueprint generates a Git Ops CI/CD pipeline for a Yakima
    cluster
openAPI:
  definitions:
    io.k8s.cli.setters.source-repo:
      description: Name of the source repository where your DRY configuration will
        live
      x-k8s-cli:
        setter:
          name: source-repo
          value: source-repo
    io.k8s.cli.setters.deployment-repo:
      description: Name of the deployment repository where your hydrated (WET) configuration
        will live
      x-k8s-cli:
        setter:
          name: deployment-repo
          value: deployment-repo
          isSet: true
    io.k8s.cli.setters.staging-branch:
      description: Name of the branch in the source repository which will be used
        to store your staging DRY configurations for validation and review without
        triggering the full Yakima pipeline. Results of hydration will be pushed to
        the same branch in the deployment repository.
      x-k8s-cli:
        setter:
          name: staging-branch
          value: staging
    io.k8s.cli.setters.namespace:
      description: Namespace to store Git Ops pipeline components under
      x-k8s-cli:
        setter:
          name: namespace
          value: yakima-system
          isSet: true
    io.k8s.cli.setters.project-id:
      description: Project ID to actuate Config Connector resources in
      x-k8s-cli:
        setter:
          name: project-id
          value: my-project-id
          isSet: true
    io.k8s.cli.substitutions.cloudbuild-sa:
      x-k8s-cli:
        substitution:
          name: cloudbuild-sa
          pattern: serviceAccount:${project-number}@cloudbuild.gserviceaccount.com
          values:
          - marker: ${project-number}
            ref: '#/definitions/io.k8s.cli.setters.project-number'
    io.k8s.cli.setters.project-number:
      description: Project number of the respective project ID. This can be found
        in the Google Cloud Console dashboard page for your project
      x-k8s-cli:
        setter:
          name: project-number
          value: "1234567890123"
          isSet: true
    io.k8s.cli.substitutions.config-sync-repo:
      x-k8s-cli:
        substitution:
          name: config-sync-repo
          pattern: https://source.developers.google.com/p/${project-id}/r/${deployment-repo}
          values:
          - marker: ${project-id}
            ref: '#/definitions/io.k8s.cli.setters.project-id'
          - marker: ${deployment-repo}
            ref: '#/definitions/io.k8s.cli.setters.deployment-repo'
    io.k8s.cli.setters.cluster-name:
      description: Name of the cluster associated with your Yakima instance
      x-k8s-cli:
        setter:
          name: cluster-name
          value: my-yakima-cluster
          isSet: true
    io.k8s.cli.substitutions.compute-sa:
      x-k8s-cli:
        substitution:
          name: compute-sa
          pattern: serviceAccount:${project-number}-compute@developer.gserviceaccount.com
          values:
          - marker: ${project-number}
            ref: '#/definitions/io.k8s.cli.setters.project-number'
    io.k8s.cli.substitutions.config-sync-workload-identity:
      x-k8s-cli:
        substitution:
          name: config-sync-workload-identity
          pattern: serviceAccount:${project-id}.svc.id.goog[config-management-system/importer]
          values:
          - marker: ${project-id}
            ref: '#/definitions/io.k8s.cli.setters.project-id'
    io.k8s.cli.substitutions.compute-sa-external:
      x-k8s-cli:
        substitution:
          name: compute-sa-external
          pattern: projects/${project-id}/serviceAccounts/${project-number}-compute@developer.gserviceaccount.com
          values:
          - marker: ${project-id}
            ref: '#/definitions/io.k8s.cli.setters.project-id'
          - marker: ${project-number}
            ref: '#/definitions/io.k8s.cli.setters.project-number'
    io.k8s.cli.substitutions.project-id-external:
      x-k8s-cli:
        substitution:
          name: project-id-external
          pattern: projects/${project-id}
          values:
          - marker: ${project-id}
            ref: '#/definitions/io.k8s.cli.setters.project-id'
